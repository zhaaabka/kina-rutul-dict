<h1>Dictionary</h1>

<p>You can search the information in all the columns given. For the full <b>lexical entry page</b>, click on the gloss in Glossing label column.</p>
<p>For searching information with virtual keyboard, click on the search in the column needed, then, use the keyboard.</p>

<div id="virtual-keyboard" class="mb-3">
  <span class="virtual-key">Ӏ</span>
  <span class="virtual-key">ˤ</span>
  <span class="virtual-key">ʷ</span>
  <span class="virtual-key">ʲ</span>
  <span class="virtual-key">ʼ</span>
  <span class="virtual-key">ː</span>
  <span class="virtual-key">ʁ</span>
  <span class="virtual-key">χ</span>
  <span class="virtual-key">ɢ</span>
  <span class="virtual-key">ɣ</span>
  <span class="virtual-key">ʔ</span>
  <span class="virtual-key">ʒ</span>
  <span class="virtual-key">ǯ</span>
  <span class="virtual-key">š</span>
  <span class="virtual-key">č</span>
  <span class="virtual-key">ɐ</span>
  <span class="virtual-key">ɞ</span>
  <span class="virtual-key">ɨ</span>
  <span class="virtual-key">ä</span>
  <span class="virtual-key">ü</span>
</div>

<table id="dict" class="display" style="width:100%">
  <thead>
    <tr>
      {% for c in columns %}
        <th>{{ c }}</th>
      {% endfor %}
    </tr>

    <tr>
      {% for c in columns %}
        <th>
          {% if c == "Part of Speech" %}
            <div class="pos-select">
              <input type="text"
                    id="pos-search"
                    class="pos-search-input"
                    placeholder="Part of speech"
                    readonly>
              <div class="pos-dropdown">
                <div data-value="noun">noun</div>
                <div data-value="verb">verb</div>
                <div data-value="adjective">adjective</div>
                <div data-value="complex noun">complex noun</div>
                <div data-value="complex verb">complex verb</div>
              </div>
            </div>
          {% else %}
            <input type="text"
                  placeholder="{{ c }}"
                  style="width:100%; box-sizing:border-box;">
          {% endif %}
        </th>
      {% endfor %}
    </tr>
  </thead>

  <tbody>
    {% for row in rows %}
      <tr>
        {% for c in columns %}
          <td>{{ row[c]|safe }}</td>
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>

<div class="dt-page-jump mt-2">
  Page:
  <input type="number"
         id="page-jump"
         min="1"
         style="width: 5em;">
  <span id="page-total"></span>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script type="application/javascript"></script>

<script>
function normalize(text) {
  if (!text) return "";

  return text
    .replace(/[I1ӏ]/g, "Ӏ")
    .toLowerCase()
    .replace(/ˁ/g, "ˤ")
    .replace(/['’]/g, "ʼ")
    .replace(/:/g, "ː")
    .normalize("NFD")
    .replace(/[\u0301]/g, "")
    .normalize("NFC");
}
</script>

<script>
let selectedPOS = [];

$(document).on('click', '#pos-search', function () {
  $('.pos-dropdown').toggle();
});

$(document).on('click', '.pos-dropdown div', function (e) {
  e.stopPropagation();

  const value = $(this).data('value');

  if (selectedPOS.includes(value)) {
    selectedPOS = selectedPOS.filter(v => v !== value);
    $(this).removeClass('active');
  } else {
    selectedPOS.push(value);
    $(this).addClass('active');
  }

  $('#pos-search').val(selectedPOS.join(', '));
  $('#dict').DataTable().draw();
});

$(document).on('click', function () {
  $('.pos-dropdown').hide();
});
</script>

<script>
const posIndex = {{ columns.index("Part of Speech") | tojson }};
</script>


<script>
$.fn.dataTable.ext.search.push(function (
  settings,
  data,
  dataIndex
) {
  const table = $('#dict').DataTable();

  let visible = true;

  $('#dict thead tr:eq(1) th').each(function (i) {

    // ===== обычный текстовый фильтр =====
    const input = $(this).find('input[type="text"]');
    if (!input.length) return;

    const query = normalize(input.val());
    if (!query) return;

    const cellText = normalize(data[i]);

    if (!cellText.includes(query)) {
      visible = false;
    }
  });

  if (selectedPOS.length) {
    const cellPOS = data[posIndex].toLowerCase().split(',').map(s => s.trim());

    const match = selectedPOS.some(pos => cellPOS.includes(pos));
    if (!match) return false;
  }

  return visible;
});
</script>

<script>
let activeInput = null;

// отслеживаем, в каком поле сейчас курсор
$(document).on('focus', '#dict thead input', function () {
  activeInput = this;
});
</script>


<script>
$(document).on('click', '.virtual-key', function () {
  if (!activeInput) return;

  const char = $(this).text();

  const start = activeInput.selectionStart;
  const end = activeInput.selectionEnd;

  const value = activeInput.value;

  activeInput.value =
    value.slice(0, start) +
    char +
    value.slice(end);

  activeInput.selectionStart =
    activeInput.selectionEnd =
    start + char.length;

  // триггерим перерисовку таблицы
  $('#dict').DataTable().draw();

  activeInput.focus();
});
</script>

<script>
const params = new URLSearchParams(window.location.search);

const savedPage = parseInt(params.get('page'), 10) || 0;
const savedOrder = JSON.parse(params.get('order') || '[[2,"asc"]]');
const savedFilters = JSON.parse(params.get('filters') || '[]');
const savedPOS = JSON.parse(params.get('pos') || '[]');
</script>


<script>
$(document).ready(function () {
  const table = $('#dict').DataTable({
    pageLength: 20,
    orderCellsTop: true,
    fixedHeader: false,
    dom: 'lrtip',
    order: savedOrder,
    stateSave: true
  });

  $('.pos-filter input').each(function () {
    if (savedPOS.includes(this.value)) {
      this.checked = true;
    }
  });


  $(document).on('change', '.pos-filter input[type="checkbox"]', function () {
    $('#dict').DataTable().draw();
  });


  $('#dict thead tr:eq(1) input').each(function (i) {
    if (savedFilters[i]) {
      this.value = savedFilters[i];
    }
  });

  table.page(savedPage).draw(false);


  table.on('stateSaveParams', function (e, settings, data) {
    const params = new URLSearchParams();

    params.set('page', data.start / data.length);
    params.set('order', JSON.stringify(data.order));
    params.set('filters', JSON.stringify(
      $('#dict thead tr:eq(1) input').map(function () {
        return this.value;
      }).get()
    ));
    params.set(
      'pos',
      JSON.stringify(
        $('.pos-filter input:checked')
          .map(function () { return this.value; })
          .get()
      )
    );


    history.replaceState(null, '', '?' + params.toString());
  });


  function updatePageInfo() {
    const info = table.page.info();
    $('#page-total').text(`of ${info.pages}`);
    $('#page-jump').val(info.page + 1);
    $('#page-jump').attr('max', info.pages);
  }

  updatePageInfo();

  table.on('draw', function () {
    updatePageInfo();
  });

  $('#page-jump').on('change', function () {
    const page = parseInt(this.value, 10) - 1;
    const info = table.page.info();

    if (page >= 0 && page < info.pages) {
      table.page(page).draw(false);
    }
  });

  
  $('#dict thead tr:eq(1) th').each(function () {
    const input = $(this).find('input');
    if (input.length) {
      input.on('keyup change clear', function () {
        table.draw();
      });
    }
  });
});

</script>

